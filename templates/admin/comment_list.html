{% extends 'admin/base.html' %}

{% block content %}
    <div class="card">
        <div class="card-header">
            <h3>留言管理</h3>
        </div>
        <div class="card-body">
            <!-- 操作栏 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="btn-group">
                        <a href="{% url 'ticket:admin_comment_list' %}" class="btn {% if not replied_filter %}btn-primary{% else %}btn-outline-primary{% endif %}">全部留言({{ total_comments }})</a>
                        <a href="{% url 'ticket:admin_comment_list' %}?replied=replied" class="btn {% if replied_filter == 'replied' %}btn-primary{% else %}btn-outline-primary{% endif %}">已回复({{ replied_comments }})</a>
                        <a href="{% url 'ticket:admin_comment_list' %}?replied=unreplied" class="btn {% if replied_filter == 'unreplied' %}btn-primary{% else %}btn-outline-primary{% endif %}">未回复({{ unreplied_comments }})</a>
                    </div>
                </div>
                <div class="col-md-6">
                    <form method="get" action="{% url 'ticket:admin_comment_list' %}" class="input-group">
                        <input type="text" class="form-control" placeholder="请输入用户名或留言内容搜索" name="search" value="{{ search_keyword }}">
                        <button class="btn btn-primary" type="submit">搜索</button>
                    </form>
                </div>
            </div>
            
            <!-- 留言列表 -->
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th scope="col">用户</th>
                        <th scope="col">景点</th>
                        <th scope="col">留言内容</th>
                        <th scope="col">留言时间</th>
                        <th scope="col">回复状态</th>
                        <th scope="col">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for comment in comments %}
                    <tr>
                        <td>{{ comment.user.username }}</td>
                        <td>{{ comment.scenic_spot.name }}</td>
                        <td>{{ comment.content|truncatechars:50 }}</td>
                        <td>{{ comment.created_at|date:"Y-m-d H:i:s" }}</td>
                        <td>
                            {% if comment.is_replied %}
                            <span class="badge bg-success">已回复</span>
                            {% else %}
                            <span class="badge bg-warning">未回复</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <!-- 查看详情和回复按钮 -->
                                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#replyModal-{{ comment.id }}">
                                    {% if comment.is_replied %}查看回复{% else %}回复留言{% endif %}
                                </button>
                                <!-- 删除按钮 -->
                                <form method="post" action="{% url 'ticket:admin_delete_comment' comment.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('确定要删除这条留言吗？')">删除</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">暂无留言数据</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 回复留言模态框 -->
    {% for comment in comments %}
    <div class="modal fade" id="replyModal-{{ comment.id }}" tabindex="-1" aria-labelledby="replyModalLabel-{{ comment.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="replyModalLabel-{{ comment.id }}">
                        {% if comment.is_replied %}查看回复 - {{ comment.user.username }}{% else %}回复留言 - {{ comment.user.username }}{% endif %}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 留言详情 -->
                    <div class="mb-4">
                        <h6>留言详情</h6>
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center">
                                        <strong>{{ comment.user.username }}</strong>
                                        <span class="text-muted ms-2">{{ comment.created_at|date:"Y-m-d H:i:s" }}</span>
                                    </div>
                                    <span class="badge bg-info">{{ comment.scenic_spot.name }}</span>
                                </div>
                                <p class="mb-0">{{ comment.content }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 回复表单或已回复内容 -->
                    {% if comment.is_replied %}
                        <!-- 已回复内容 -->
                        <div class="mb-4">
                            <h6>管理员回复</h6>
                            <div class="card bg-light border-primary">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <strong>管理员</strong>
                                        <span class="text-muted">{{ comment.reply_time|date:"Y-m-d H:i:s" }}</span>
                                    </div>
                                    <p class="mb-0">{{ comment.reply }}</p>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <!-- 回复表单 -->
                        <form method="post" action="{% url 'ticket:admin_reply_comment' comment.id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="replyContent-{{ comment.id }}" class="form-label">回复内容</label>
                                <textarea class="form-control" id="replyContent-{{ comment.id }}" name="reply_content" rows="4" required placeholder="请输入回复内容..."></textarea>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">取消</button>
                                <button type="submit" class="btn btn-primary">提交回复</button>
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endblock content %}