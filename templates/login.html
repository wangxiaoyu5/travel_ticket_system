{% extends 'base.html' %}

{% block content %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header text-center">
                        <h3>用户登录</h3>
                    </div>
                    <div class="card-body">
                        <form method="post">
                            {% csrf_token %}
                            {% if next %}
                            <input type="hidden" name="next" value="{{ next }}">
                            {% endif %}
                            
                            <!-- 登录错误信息提示 -->
                            {% if messages %}
                            <div class="mb-3">
                                {% for message in messages %}
                                <div class="alert alert-danger alert-dismissible fade show" role="alert" style="margin-bottom: 0;">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                <label for="username" class="form-label">用户名</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">密码</label>
                                <input type="password" class="form-control" id="password" name="password" required>
                            </div>
                            
                            <!-- 角色选择 -->
                            <div class="mb-3">
                                <label class="form-label">角色</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="role" id="role_visitor" value="0" checked>
                                        <label class="form-check-label" for="role_visitor">
                                            游客
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="role" id="role_scenic_admin" value="1">
                                        <label class="form-check-label" for="role_scenic_admin">
                                            景点管理员
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="role" id="role_platform_admin" value="2">
                                        <label class="form-check-label" for="role_platform_admin">
                                            管理员
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 景点选择（仅景点管理员需要） -->
                            <div class="mb-3" id="scenic_selector" style="display: none;">
                                <label for="scenic_spot" class="form-label">景点</label>
                                <select class="form-select" id="scenic_spot" name="scenic_spot">
                                    <option value="">请选择景点</option>
                                    <!-- 这里会通过JavaScript动态加载景点列表 -->
                                </select>
                            </div>
                            
                            <div class="d-grid mb-3">
                                <button type="submit" class="btn btn-primary">登录</button>
                            </div>
                            
                            <!-- 注册和忘记密码链接 -->
                            <div class="text-center">
                                <a href="{% url 'ticket:register' %}" class="me-3">注册新账号</a>
                                <a href="#">忘记密码</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 加载景点列表
        function loadScenicSpots() {
            fetch('/api/scenic_spots/')
                .then(response => response.json())
                .then(data => {
                    const selectElement = document.getElementById('scenic_spot');
                    // 清空现有选项（保留第一个占位选项）
                    selectElement.innerHTML = '<option value="">请选择景点</option>';
                    // 添加景点选项
                    data.forEach(spot => {
                        const option = document.createElement('option');
                        option.value = spot.id;
                        option.textContent = spot.name;
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => console.error('加载景点列表失败:', error));
        }
        
        // 页面加载时加载景点列表
        window.addEventListener('load', loadScenicSpots);
        
        // 角色选择切换时，显示/隐藏景点选择器
        document.querySelectorAll('input[name="role"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const scenicSelector = document.getElementById('scenic_selector');
                if (this.value === '1') {
                    scenicSelector.style.display = 'block';
                    // 确保景点列表已加载
                    loadScenicSpots();
                } else {
                    scenicSelector.style.display = 'none';
                }
            });
        });
    </script>
{% endblock %}